---
- hosts: devel

  vars:
    ubuntu: utopic

  tasks:
    - name: install aptitude first
      apt: pkg=aptitude state=installed
      sudo: True

    # TODO: Remove when 24.4 is in stable
    - name: add emacs repos
      apt_repository: repo='{{item}} http://ppa.launchpad.net/ubuntu-elisp/ppa/ubuntu {{ubuntu}} main'
      sudo: True
      tags: [emacs]
      with_items:
        - deb

    - apt_repository: repo=ppa:hansjorg/rust
      sudo: True
      tags: [packages]

    - name: install userspace packages
      apt: pkg={{item}} state=installed
      sudo: True
      tags: [packages]
      with_items:
        - aspell-en
        - build-essential
        - cloc
        - curl
        - emacs-snapshot
        - git
        - gnuplot-x11
        - graphviz
        - htop
        - imagemagick
        - libffi-dev # rbenv
        - libssl-dev # rbenv
        - libreadline-dev # rbenv
        - libyaml-dev # rbenv
        - openjdk-8-jdk
        - openssh-server # TODO setup etc config
        - postgresql
        - postgresql-server-dev-9.4
        - pv
        # - r-base-core
        - rust-1.0.0-beta
        - silversearcher-ag
        - sqlite3
        # - texlive-fonts-recommended
        # - texlive-latex-extra
        # - texlive-latex-recommended
        # - texlive-xetex
        - tmux
        - tree
        - wamerican # /usr/share/dict/words
        - whois
        - wordnet
        - xournal
        - xsel
        - zsh

    - name: create the src working directory
      file: path=~/src/vendor state=directory
      tags: [users]

    - name: clone dotfiles
      git: repo=git@github.com:jmdeldin/dotfiles.git dest=~/src/etc update=False
      tags: [git]

    - name: link dotfiles
      file: path=~/{{item}} src=~/src/etc/{{item}} state=link
      tags: [git]
      with_items:
        - .gitconfig
        - .gitignore
        - .screenrc
        - .tmux.conf
        - .zshenv
        - .zshrc

    - name: switch to ZSH
      user: name={{ansible_ssh_user}} shell=/usr/bin/zsh
      sudo: True
      tags: [packages, users]

    - name: clone .emacs.d
      git: repo=git@github.com:jmdeldin/.emacs.d.git dest=~/.emacs.d update=False
      tags: [git]

    - name: setup rbenv
      git: repo=git@github.com:sstephenson/rbenv.git dest=~/.rbenv update=False
      tags: [ruby]

    - name: setup ruby-build
      git: repo=git@github.com:sstephenson/ruby-build.git dest=~/.rbenv/plugins/ruby-build update=False
      tags: [ruby]

    - name: build ruby version
      command: rbenv install 2.2.1 creates=~/.rbenv/versions/2.2.1
      tags: [ruby]

    - name: set global version
      command: rbenv global 2.2.1 creates=~/.rbenv/version
      tags: [ruby]

    - name: install base gems
      gem: name={{item}} state=present include_dependencies=True
      tags: [ruby]
      notify: [rehash ruby gems]
      with_items:
        - algoplot
        - benchmark-ips
        - bundler
        - hitch
        - pry
        - pry-doc

    - name: disable password ssh
      lineinfile: dest=/etc/ssh/sshd_config state=present
                  line="PasswordAuthentication no"
      tags: [net]
      sudo: True

    - name: copy iptables
      copy: src=templates/etc/iptables.rules dest=/etc/iptables.rules
      sudo: True
      tags: [net]

    - name: load iptables
      lineinfile: dest=/etc/network/interfaces state=present
                  line="pre-up iptables-restore < /etc/iptables.rules"
      tags: [net]
      sudo: True

    - include: system76_tasks.yml
    - include: theclymb_tasks.yml

  handlers:
    - include: system76_handlers.yml
    - include: theclymb_handlers.yml

    - name: rehash ruby gems
      command: rbenv rehash
