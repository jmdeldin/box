# vncviewer
- name: add System76 repo
  sudo: True
  tags: [system76]
  apt_repository: repo=ppa:system76-dev/stable

- name: stupid flash workaround for DRM
  sudo: True
  tags: [system76]
  apt_repository: repo=ppa:mjblenner/ppa-hal

- name: install system76 drivers & other GUI software
  apt: pkg={{item}} state=installed
  sudo: True
  tags: [system76, packages]
  with_items:
    - chromium-browser
    - gcolor2 # color picker
    - gimp
    - gnome-tweak-tool # set Emacs keybindings + caps lock
    - hal
    - mplayer
    - redshift
    - system76-driver
    - unity-tweak-tool # remove desktop from alt-tab
    - virtualbox
    - xournal

- name: music
  apt: pkg={{item}} state=installed
  sudo: True
  tags: [sytem76, music]
  with_items:
    - easytag
    - gmpc # handy for quickly checking tags
    - mpc
    - mpd
    - mpdcron # last.fm scrobbling
    - ncmpcpp # viewer
    - python-pip # for beets

- name: install deps for beets
  pip: name={{item}} state=present
  sudo: True
  tags: [system76, music]
  with_items:
    - beets
    - flask
    - requests
    - pylast
    - python-mpd2

- stat: path=/lib/systemd/system/mpd.service
  register: mpd_srv
  tags: [system76, music]

- name: unregister mpd -- we run this as $user
  service: name=mpd state=stopped enabled=no
  sudo: True
  tags: [system76, music]
  when: mpd_srv.stat.exists

- name: remove mpd service
  file: path=/lib/systemd/system/mpd.service state=absent
  sudo: True
  when: mpd_srv is defined
  tags: [system76, music]

- stat: path=/etc/init.d/mpd
  register: mpd_srv
  tags: [system76, music]

- name: remove mpd service
  file: path=/etc/init.d/mpd state=absent
  sudo: True
  when: mpd_srv is defined
  tags: [system76, music]

- name: remove garbage packages
  apt: pkg={{item}} state=absent purge=yes
  sudo: True
  tags: [system76, packages]
  with_items:
    - empathy
    - thunderbird
    - rhythmbox
    - unity-lens-shopping

# SSD optimizations
# https://wiki.debian.org/SSDOptimization
# http://blog.christophersmart.com/2013/06/05/trim-on-lvm-on-luks-on-ssd/
- name: SSD optimization for lvm
  lineinfile: dest=/etc/lvm/lvm.conf state=present backrefs=yes
              regexp="issue_discards = 0" line="issue_discards = 1"
  tags: [ssd]
  sudo: True

- name: SSD optimization for crypttab
  lineinfile: dest=/etc/crypttab state=present backrefs=yes backup=yes
              regexp="(.*) luks" line="\1 luks,discard"
  tags: [ssd]
  sudo: True
  notify: [rebuild boot image]

- cron: name="trim /" hour="10" job="fstrim /"
  sudo: True
  tags: [system76]
